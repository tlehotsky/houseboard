<!doctype html><meta charset="utf-8"><title>HouseBoard – DayBuddy</title>
<!doctype html><meta charset="utf-8"><title>HouseBoard – DayBuddy</title>
<style>
/* ---- Base --------------------------------------------------------------- */
body{background:#0b0c10;color:#f2f5f9;font:400 16px/1.5 system-ui;margin:0}
/* Inset border around the entire viewport */
body::after{
  content:"";
  position:fixed;
  inset:8px;                 /* distance from the screen edge */
  border:1px solid rgba(255,255,255,.6); /* thin white border */
  border-radius:10px;        /* slight rounding; adjust if you prefer square corners */
  pointer-events:none;       /* don't block clicks */
  z-index:9999;              /* render above all content */
}
.wrap{padding:16px}
.legend{
  display:flex;
  gap:12px;
  margin:20px 0 24px;
  flex-wrap:wrap;
  justify-content:center;
}
.pill{
  display:inline-block;
  background: var(--c);
  color:#fff;
  border:1px solid rgba(255,255,255,.25);
  border-radius:999px;
  padding:6px 14px;
  font-weight:700;
  font-size:15px;
  letter-spacing:0.2px;
  box-shadow:0 2px 6px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.25);
  transition:transform .1s ease, box-shadow .1s ease;
  text-shadow:0 1px 1px rgba(0,0,0,.4);
}
.pill:hover{
  transform:translateY(-1px);
  box-shadow:0 3px 10px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.3);
}
.badge{display:inline-flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;box-shadow:0 0 0 1px rgba(255,255,255,.08), inset 0 0 0 1px rgba(0,0,0,.6)}
/* color picker input styled like the old swatch */
.row input.clr{width:22px;height:22px;border-radius:50%;border:1px solid #2a3750;padding:0;background:none;appearance:none;-webkit-appearance:none;cursor:pointer}
.row input.clr::-webkit-color-swatch-wrapper{padding:0;border-radius:50%}
.row input.clr::-webkit-color-swatch{border:none;border-radius:50%}
/* ---- Grid --------------------------------------------------------------- */
.grid{
  display:grid;
  grid-template-columns:repeat(7,minmax(0,1fr));
  gap:6px;
  margin:0 20px; /* adds whitespace on both sides */
}
/* ---- Weather cards ----------------------------------------------------- */
.cards{
  display:grid;
  grid-template-columns:minmax(200px,20%) minmax(0,80%);
  gap:12px;
  margin:16px 20px 90px;
}
@media (max-width: 980px){
  .cards{ grid-template-columns: 1fr; }
}
.card{background:#1b1f29;border:1px solid #333;border-radius:10px;padding:12px;min-width:0}
.card h4{margin:0 0 8px 0;font-weight:700;opacity:.9}
.card .big{font-size:176px;font-weight:800;letter-spacing:0.5px}
.card .big .unit{ font-size:0.5em; margin-left:6px; opacity:.9; }
.card .muted{opacity:.75;font-size:14px}
#wxChart{width:100%;height:220px;display:block}
.cell{
  min-height:120px;
  background:#1b1f29;           /* slightly lighter than before for better contrast */
  border:1px solid #333;        /* softer, consistent gray lines */
  border-radius:8px;
  padding:8px;
  min-width:0;
}
.date{opacity:.75;font-weight:700;text-align:right;font-size:20px}
/* header row inside a day cell: all-day pills left, date right */
.cell-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:6px}
.allbar{display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start;overflow:hidden}
/* ---- Events ------------------------------------------------------------- */
.evt{
  color:#e8ecf3;                /* crisp event text */
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  background: var(--c);
  color:#fff;
  border-radius:6px;
  padding:2px 8px;
  margin:.18rem 0;
  font-size: var(--sz, 16px);
  display:flex;                 /* allow inline badges */
  align-items:flex-start;
  gap:6px;
}
/* ensure flex children truncate nicely so widths stay uniform */
.evt{ min-width:0; }
.evt b{ flex:0 0 auto; }
.evt span{ flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block; }
/* all‑day or multi‑day highlight tint for readability on dark ui */
.all{
  background: var(--c);
  border-radius:6px;
  padding:2px 8px;
}
/* compact pill tag for all-day entries */
.tag-all{
  font-size:14px;
  padding:0 6px;
  flex:0 0 auto;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background: var(--c);
  color:#fff;
  max-width:100%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  opacity:.9;
}
/* subtle de-emphasis for trailing author */
.who{opacity:.75}
.evt b{font-weight:700}
.evt span, .evt b { color:#fff; text-shadow:0 1px 1px rgba(0,0,0,.25); }
/* ---- Time grid (7:00–19:00 in 30-min slots) ----------------------------- */
.timegrid{--gutter:60px;display:grid;grid-template-rows:repeat(24,28px);row-gap:0;margin:6px 0 8px 0;position:relative}
.slot{border-top:1px dashed #2a3750;position:relative; z-index:0}
.slot.hour{border-top:1px solid #3b5172}
.slot .label{position:absolute;left:4px;top:-9px;font-size:11px;opacity:.65;user-select:none}
/* events placed into time slots */
.slot .evt{ margin:2px 4px; width:auto; }
/* absolute-positioned duration blocks */
.timegrid{ position:relative; }
.timegrid .overlay{ position:absolute; top:0; bottom:0; left:var(--gutter); right:0; z-index:2; pointer-events:none; }
.timegrid .overlay .evt{ position:absolute; left:2px; right:2px; margin:0; padding-top:4px; }
/* ---- Footer buttons ----------------------------------------------------- */
.footer{position:fixed;left:0;right:0;bottom:0;background:#0f1217;border-top:1px solid #1a1d22;padding:8px;display:flex;gap:8px;justify-content:center}
.footer button{
  background:#1a2333;
  color:#f2f5f9;
  border:1px solid #2a3750;
  border-radius:10px;
  padding:10px 14px;
  font-weight:600;
  cursor:pointer;
  transition:transform .06s ease, background .12s ease, border-color .12s ease
}
.footer button:hover{transform:translateY(-1px);background:#21314a;border-color:#3b5172}
.footer button:active{transform:translateY(0)}

/* ---- Slide-out menu ----------------------------------------------------- */
#gear{position:fixed;top:14px;right:14px;background:#1a2333;border:1px solid #2a3750;color:#f2f5f9;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer;z-index:20}
.drawer{position:fixed;top:0;right:-380px;width:360px;height:100vh;background:#0e1218;border-left:1px solid #22293a;box-shadow: -12px 0 24px rgba(0,0,0,.35);transition:right .18s ease;z-index:30;display:flex;flex-direction:column}
.drawer.open{right:0}
.drawer header{padding:16px;border-bottom:1px solid #1a1d22;font-weight:700}
.drawer .body{padding:16px;overflow:auto;flex:1}
.row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.row input[type="text"]{flex:1;background:#141b24;border:1px solid #283246;border-radius:8px;padding:8px;color:#f2f5f9}
.row input[type="number"]{background:#141b24;border:1px solid #283246;border-radius:8px;padding:8px;color:#f2f5f9}
.actions{padding:12px 16px;border-top:1px solid #1a1d22;display:flex;gap:8px;justify-content:flex-end}
.actions button{background:#1a2333;color:#f2f5f9;border:1px solid #2a3750;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
.actions button:hover{background:#21314a;border-color:#3b5172}
</style>

<div id="gear">⚙ Calendars</div>

<div class="wrap">
  {{ people|json_script:"people-data" }}
  <h1>DayBuddy – Week View</h1>
  <h3 style="text-align:center;opacity:.8;margin-top:12px;margin-bottom:4px;font-weight:600;">Week Legend</h3>
  <div class="legend">
    {% for p in people %}<span class="pill" style="--c:{{p.color}}">{{p.name}}</span>{% endfor %}
  </div>
  <div class="grid">
    {% for cell in cells %}
      <div class="cell">
        <div class="cell-head">
          <div class="allbar">
            {% for e in cell.events %}
              {% if e.all_day %}
                {% if e.title or e.time_label %}
                  <span class="tag-all" style="--c:{{ e.color }}">{{ e.title|default:"ALL DAY" }}</span>
                {% endif %}
              {% endif %}
            {% endfor %}
          </div>
          <div class="date">{{ cell.pretty }}</div>
        </div>
        <div class="timegrid"><div class="overlay"></div></div>
        {% for e in cell.events %}
          {% if not e.all_day %}
            {% if e.title or e.time_label %}
              <div class="evt" data-start="{{ e.time_label|default:'' }}" data-end="{{ e.end_time_label|default:'' }}" style="--c:{{e.color}};--sz:{{ e.font_size|default:16 }}px">
                {% if e.time_label %}<b>{{ e.time_label }}</b>{% endif %}
                <span>{{ e.who }}{% if e.title %}: {{ e.title }}{% endif %}</span>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>
  <div class="cards" id="weather-cards">
    <div class="card" id="card-now">
      <h4>Red Bank, NJ (07701) — Now</h4>
      <div class="big" id="now-temp">—</div>
      <div class="muted" id="now-updated">Loading current conditions…</div>
    </div>
    <div class="card" id="card-forecast">
      <h4>Temperature & Rain Chance (next 7 days)</h4>
      <svg id="wxChart" viewBox="0 0 1400 220" preserveAspectRatio="none"></svg>
      <div class="muted" id="wxNote">Line = °F, Bars = % chance of precipitation</div>
    </div>
  </div>
</div>



<div class="drawer" id="drawer">
  <header>Edit calendars</header>
  <div class="body" id="drawer-body"></div>
  <div class="actions">
    <button id="cancel">Close</button>
    <button id="save">Save</button>
  </div>
</div>

<div class="footer">
  <button data-act="prev">◀ Prev</button>
  <button data-act="today">Today</button>
  <button data-act="next">Next ▶</button>
  <button data-act="mode">Mode</button>
  <button data-act="open">Open</button>
</div>

<script>
function goDate(y,m,d){
  const u = new URL(location);
  u.searchParams.set('y', y);
  u.searchParams.set('m', m);
  u.searchParams.set('d', d);
  location = u.toString();
}

const now = new Date();
function getAnchor(){
  const u = new URL(location);
  const yy = parseInt(u.searchParams.get('y') || now.getFullYear());
  const mm = parseInt(u.searchParams.get('m') || (now.getMonth()+1));
  const dd = parseInt(u.searchParams.get('d') || now.getDate());
  return new Date(yy, mm-1, dd);
}
const anchor = getAnchor();

document.querySelector('[data-act="prev"]').onclick = () => {
  const d = new Date(anchor);
  d.setDate(d.getDate() - 7);
  goDate(d.getFullYear(), d.getMonth()+1, d.getDate());
};

document.querySelector('[data-act="next"]').onclick = () => {
  const d = new Date(anchor);
  d.setDate(d.getDate() + 7);
  goDate(d.getFullYear(), d.getMonth()+1, d.getDate());
};

document.querySelector('[data-act="today"]').onclick = () => {
  goDate(now.getFullYear(), now.getMonth()+1, now.getDate());
};

// People data for drawer
const PEOPLE = JSON.parse(document.getElementById('people-data').textContent);

const gear = document.getElementById('gear');
const drawer = document.getElementById('drawer');
const bodyEl = document.getElementById('drawer-body');
const cancelBtn = document.getElementById('cancel');
const saveBtn = document.getElementById('save');

function buildTimeGrid(el){
  // 24 slots: 7:00, 7:30, …, 18:30 (ending right at 19:00)
  const startMinutes = 7*60; // 7:00
  for (let i=0;i<24;i++){
    const m = startMinutes + i*30;
    const hh = Math.floor(m/60);
    const mm = m%60;
    const isHour = (mm===0);
    const label = isHour ? ((hh%12||12)+":00"+(hh<12?"a":"p")) : ((hh%12||12)+":30"+(hh<12?"a":"p"));
    const div = document.createElement('div');
    div.className = 'slot' + (isHour ? ' hour' : '');
    if(isHour){
      const span = document.createElement('span');
      span.className = 'label';
      span.textContent = label;
      div.appendChild(span);
    }
    el.appendChild(div);
  }
  const ov = el.querySelector('.overlay'); if(ov) el.appendChild(ov);
}

// Populate all timegrids in the week view

for (const tg of document.querySelectorAll('.timegrid')) buildTimeGrid(tg);

function parseStartMinutes(label){
  if(!label) return null;
  // Accept forms like "7:00 AM", "7:30PM", "7a", "7:30p"
  const s = label.trim().toLowerCase().replace(/\s+/g,'');
  const m = s.match(/^(\d{1,2})(?::(\d{2}))?([ap])m?$/);
  if(!m) return null;
  let h = parseInt(m[1],10);
  let min = m[2] ? parseInt(m[2],10) : 0;
  const ap = m[3];
  h = h % 12 + (ap === 'p' ? 12 : 0);
  return h*60 + min;
}

function placeEventsIntoGrid(){
  const SLOT_PX = 28;           // matches CSS row height
  const WINDOW_START = 7*60;    // 420 = 7:00
  const WINDOW_END   = 19*60;   // 1140 = 19:00

  const CELLS = document.querySelectorAll('.cell');
  for(const cell of CELLS){
    const grid = cell.querySelector('.timegrid');
    if(!grid) continue;
    const overlay = grid.querySelector('.overlay');
    const evts = [...cell.querySelectorAll('.evt')].filter(e => e.closest('.cell') === cell);

    for(const evt of evts){
      const startLabel = (evt.getAttribute('data-start') || '').trim();
      const endLabel   = (evt.getAttribute('data-end') || '').trim();
      let startMin = parseStartMinutes(startLabel);
      if(startMin == null) continue;  // skip if we cannot place
      let endMin = parseStartMinutes(endLabel);
      if(endMin == null || endMin <= startMin) endMin = startMin + 60; // default 1 hour

      // clamp to visible window
      if(endMin <= WINDOW_START || startMin >= WINDOW_END) continue; // completely outside
      startMin = Math.max(startMin, WINDOW_START);
      endMin   = Math.min(endMin,   WINDOW_END);

      const top = ((startMin - WINDOW_START) / 30) * SLOT_PX;
      const h   = Math.max(20, ((endMin - startMin) / 30) * SLOT_PX - 4);

      // absolutely position inside overlay
      evt.style.position = 'absolute';
      evt.style.top = top + 'px';
      evt.style.height = h + 'px';
      evt.style.left = '2px';
      evt.style.right = '2px';

      overlay.appendChild(evt);
    }
  }
}

placeEventsIntoGrid();

function openDrawer(){
  bodyEl.innerHTML = PEOPLE.map(p => `
    <div class="row" data-id="${p.id}">
      <input type="color" class="clr" value="${p.color}" title="Pick color" />
      <input type="text" class="nm" value="${p.name}" placeholder="Display name" />
      <input type="number" class="fs" value="${p.font_size || 16}" min="10" max="24" step="1" style="width:72px" />
    </div>
  `).join('');
  drawer.classList.add('open');
}
function closeDrawer(){ drawer.classList.remove('open'); }

gear.addEventListener('click', openDrawer);
cancelBtn.addEventListener('click', closeDrawer);

saveBtn.addEventListener('click', async () => {
  const rows = [...bodyEl.querySelectorAll('.row')];
  for (const r of rows) {
    const id = r.getAttribute('data-id');
    const name = r.querySelector('input.nm').value.trim();
    const fs   = parseInt(r.querySelector('input.fs').value,10) || 16;
    const color = (r.querySelector('input.clr')?.value || '').trim();
    if (!id || !name) continue;
    try {
      const res = await fetch('/houseboard/daybuddy/rename', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({id, name, font_size: fs, color})
      });
      if (!res.ok) {
        console.error('Rename failed for', id, await res.text());
      }
    } catch(e) {
      console.error(e);
    }
  }
  location.reload();
});

// ---- Weather: 07701 (Red Bank, NJ) --------------------------------------
(async function loadWeather(){
  try{
    const LAT = 40.35, LON = -74.07; // Red Bank approx
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,precipitation_probability&daily=sunrise,sunset&current=temperature_2m&temperature_unit=fahrenheit&timezone=America%2FNew_York&forecast_days=10`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Weather fetch failed');
    const data = await res.json();

    // 1) Current temperature card
    const nowEl = document.getElementById('now-temp');
    if(data.current && typeof data.current.temperature_2m === 'number'){
      nowEl.innerHTML = Math.round(data.current.temperature_2m) + '<span class="unit">°F</span>';
    } else {
      nowEl.textContent = '—';
    }
    const upd = document.getElementById('now-updated');
    upd.textContent = 'Updated just now';

    // 2) Forecast chart (next 72 hours)
    const hours = data.hourly?.time || [];
    const temps = data.hourly?.temperature_2m || [];
    const pops  = data.hourly?.precipitation_probability || [];
    const takeN = Math.min(hours.length, 168); // next 7 days

    const pts = [];
    const bars = [];
    let tmin = Infinity, tmax = -Infinity;
    for(let i=0;i<takeN;i++){
      const t = temps[i];
      if(typeof t === 'number'){
        tmin = Math.min(tmin, t); tmax = Math.max(tmax, t);
      }
    }
    if(!isFinite(tmin) || !isFinite(tmax)) { tmin = 30; tmax = 90; }
    // pad range a little
    const pad = 2; tmin -= pad; tmax += pad;

    // SVG size (viewBox 0..1400 x 0..220)
    const W=1400, H=220;
    const tempTop = 10, tempBottom = 130; // top region for temp line
    const barBottom = H-20, barMaxH = 70; // lower region for precip bars

    const xStep = (W-20) / Math.max(1, takeN-1);
    for(let i=0;i<takeN;i++){
      const x = 10 + i*xStep;
      const t = temps[i];
      const p = (typeof pops[i] === 'number') ? pops[i] : 0;
      // map temp to y
      const y = (1 - (t - tmin)/(tmax - tmin)) * (tempBottom - tempTop) + tempTop;
      pts.push(`${x},${y}`);
      // precip bar
      const bh = Math.max(0, Math.min(barMaxH, (p/100)*barMaxH));
      bars.push({x, y: barBottom - bh, h: bh});
    }

    const svg = document.getElementById('wxChart');
    // clear
    while(svg.firstChild) svg.removeChild(svg.firstChild);

    // day bands & labels (start/end of each day)
    const dayGroup = document.createElementNS('http://www.w3.org/2000/svg','g');
    // dayGroup opacity removed so labels render full-white

    // Find indices where a new day starts
    const dayBreakIdx = [0];
    for(let i=1;i<takeN;i++){
      const dPrev = new Date(hours[i-1]);
      const dCurr = new Date(hours[i]);
      if(dPrev.getDate() !== dCurr.getDate() || dPrev.getMonth() !== dCurr.getMonth()){
        dayBreakIdx.push(i);
      }
    }
    // ensure we close the last segment
    if(dayBreakIdx[dayBreakIdx.length-1] !== takeN-1){
      dayBreakIdx.push(takeN-1);
    }

    for(let k=0;k<dayBreakIdx.length-1;k++){
      const s = dayBreakIdx[k];
      const e = dayBreakIdx[k+1];
      const x1 = 10 + s*xStep;
      const x2 = 10 + e*xStep;
      const w  = Math.max(1, x2 - x1);

      // alternating subtle background band
      const band = document.createElementNS('http://www.w3.org/2000/svg','rect');
      band.setAttribute('x', x1);
      band.setAttribute('y', 8);
      band.setAttribute('width', w);
      band.setAttribute('height', H-30);
      band.setAttribute('fill', (k % 2 === 0) ? '#ffffff' : '#7aa4d3');
      band.setAttribute('opacity', (k % 2 === 0) ? '0.08' : '0.06');
      dayGroup.appendChild(band);

      // day boundary line at start
      const dl = document.createElementNS('http://www.w3.org/2000/svg','line');
      dl.setAttribute('x1', x1);
      dl.setAttribute('y1', 8);
      dl.setAttribute('x2', x1);
      dl.setAttribute('y2', H-22);
      dl.setAttribute('stroke', '#a8b6d2');
      dl.setAttribute('stroke-width', '1');
      dl.setAttribute('opacity', '0.55');
      dayGroup.appendChild(dl);

      // day label (e.g., Mon 11/09) centered in band
      const labelDate = new Date(hours[s]);
      const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][labelDate.getDay()];
      const mon = labelDate.getMonth()+1;
      const day = labelDate.getDate();
      const cx = x1 + w/2;
      const tLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
      tLabel.setAttribute('x', cx);
      tLabel.setAttribute('y', tempTop + 12);
      tLabel.setAttribute('text-anchor', 'middle');
      tLabel.setAttribute('fill', '#ffffff');
      tLabel.setAttribute('font-size', '12');
      tLabel.textContent = `${dow} ${mon}/${day}`;
      dayGroup.appendChild(tLabel);
    }
    svg.appendChild(dayGroup);

    // night bands: from daily sunset to next day's sunrise
    if (data.daily && Array.isArray(data.daily.sunset) && Array.isArray(data.daily.sunrise)){
      const nightGroup = document.createElementNS('http://www.w3.org/2000/svg','g');
      nightGroup.setAttribute('opacity','0.40');
      nightGroup.setAttribute('stroke','none');
      const X_MIN = 10, X_MAX = 10 + (takeN-1)*xStep;
      const yTop = 8, yBot = H-22;

      const findX = (dt) => {
        // find first hourly index >= dt
        for(let i=0;i<takeN;i++){
          const hi = new Date(hours[i]).getTime();
          if (hi >= dt.getTime()){
            const x = X_MIN + i*xStep;
            return Math.min(X_MAX, Math.max(X_MIN, x));
          }
        }
        return null;
      };

      const sunr = data.daily.sunrise;
      const suns = data.daily.sunset;
      const daysN = Math.min(sunr.length, suns.length);

      for(let k=0;k<daysN;k++){
        const sunset = new Date(suns[k]);
        const nextSunrise = (k+1 < sunr.length) ? new Date(sunr[k+1]) : null;
        if(!nextSunrise) continue;
        let x1 = findX(sunset);
        let x2 = findX(nextSunrise);
        // if next sunrise is beyond plotted range but we have sunset inside, fill to end
        if (x1==null && x2==null) continue; // both out of range
        if (x1==null && x2!=null) x1 = X_MIN; // started before range
        if (x1!=null && x2==null) x2 = X_MAX; // ends after range
        if (x1!=null && x2!=null && x2 > x1){
          const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect.setAttribute('x', x1);
          rect.setAttribute('y', yTop);
          rect.setAttribute('width', x2 - x1);
          rect.setAttribute('height', yBot - yTop);
          rect.setAttribute('fill', '#4e7ad9'); // lighter night tint for contrast
          nightGroup.appendChild(rect);
        }
      }
      svg.appendChild(nightGroup);
    }

    // grid lines each 12 hours
    const grid = document.createElementNS('http://www.w3.org/2000/svg','g');
    grid.setAttribute('opacity','0.2');
    for(let i=0;i<takeN;i++){
      const dt = new Date(hours[i]);
      if(dt.getHours()===0 || dt.getHours()===12){
        const x = 10 + i*xStep;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',x); line.setAttribute('y1',8);
        line.setAttribute('x2',x); line.setAttribute('y2',H-22);
        line.setAttribute('stroke','#9fb3d1'); line.setAttribute('stroke-width','1'); line.setAttribute('stroke-dasharray','3,3');
        grid.appendChild(line);
      }
    }
    svg.appendChild(grid);
    // bottom axis ticks and labels for 12am / 12pm
    const bottomAxis = document.createElementNS('http://www.w3.org/2000/svg','g');
    const yBottomAxis = H - 22; // chart bottom line
    for(let i=0;i<takeN;i++){
      const dt = new Date(hours[i]);
      const hr = dt.getHours();
      if(hr === 0 || hr === 12){
        const x = 10 + i*xStep;
        // tick mark
        const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
        tick.setAttribute('x1', x);
        tick.setAttribute('y1', yBottomAxis);
        tick.setAttribute('x2', x);
        tick.setAttribute('y2', yBottomAxis - 6);
        tick.setAttribute('stroke', '#e6efff');
        tick.setAttribute('stroke-width', '1');
        bottomAxis.appendChild(tick);
        // label
        const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
        lbl.setAttribute('x', x);
        lbl.setAttribute('y', H - 6);
        lbl.setAttribute('text-anchor', 'middle');
        lbl.setAttribute('fill', '#ffffff');
        lbl.setAttribute('font-size', '10');
        lbl.textContent = (hr === 0) ? '12am' : '12pm';
        bottomAxis.appendChild(lbl);
      }
    }
    svg.appendChild(bottomAxis);

    // precip y-axis markers at 25/50/75/100%
    const yAxis = document.createElementNS('http://www.w3.org/2000/svg','g');
    const pctMarks = [25,50,75,100];
    for(const pct of pctMarks){
      const y = barBottom - (pct/100)*barMaxH;
      // tick line across precip band
      const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
      tick.setAttribute('x1', 10);
      tick.setAttribute('y1', y);
      tick.setAttribute('x2', W-10);
      tick.setAttribute('y2', y);
      tick.setAttribute('stroke', '#a8b6d2');
      tick.setAttribute('stroke-width', '1');
      tick.setAttribute('stroke-dasharray', '2,4');
      tick.setAttribute('opacity', '0.55');
      yAxis.appendChild(tick);

      // right-side label
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', W-8);
      lbl.setAttribute('y', y-2);
      lbl.setAttribute('text-anchor', 'end');
      lbl.setAttribute('fill', '#e6efff');
      lbl.setAttribute('font-size', '12');
      lbl.textContent = pct + '%';
      yAxis.appendChild(lbl);
    }
    svg.appendChild(yAxis);

    // temperature y-axis markers at 25/50/75/100 °F (only if within range)
    const tAxis = document.createElementNS('http://www.w3.org/2000/svg','g');
    const tMarks = [25,50,75,100];
    for(const val of tMarks){
      if(!(val >= tmin && val <= tmax)) continue; // skip values outside current plotted temp range
      const yT = (1 - (val - tmin)/(tmax - tmin)) * (tempBottom - tempTop) + tempTop;
      // tick line across the temperature band
      const tLine = document.createElementNS('http://www.w3.org/2000/svg','line');
      tLine.setAttribute('x1', 10);
      tLine.setAttribute('y1', yT);
      tLine.setAttribute('x2', W-10);
      tLine.setAttribute('y2', yT);
      tLine.setAttribute('stroke', '#a8b6d2');
      tLine.setAttribute('stroke-width', '1');
      tLine.setAttribute('stroke-dasharray', '2,4');
      tLine.setAttribute('opacity', '0.55');
      tAxis.appendChild(tLine);

      // left-side label (avoid overlap with precip labels on the right)
      const tLbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      tLbl.setAttribute('x', 12);
      tLbl.setAttribute('y', yT-2);
      tLbl.setAttribute('text-anchor', 'start');
      tLbl.setAttribute('fill', '#f0f6ff');
      tLbl.setAttribute('font-size', '12');
      tLbl.textContent = `${val}°F`;
      tAxis.appendChild(tLbl);
    }
    svg.appendChild(tAxis);

    // precip area (filled, continuous)
    const areaPts = [];
    // start at left baseline
    areaPts.push(`10,${barBottom}`);
    for(let i=0;i<takeN;i++){
      const x = 10 + i*xStep;
      const p = (typeof pops[i] === 'number') ? pops[i] : 0;
      const bh = Math.max(0, Math.min(barMaxH, (p/100)*barMaxH));
      const y = barBottom - bh;
      areaPts.push(`${x},${y}`);
    }
    // end at right baseline
    areaPts.push(`${10 + (takeN-1)*xStep},${barBottom}`);

    const area = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    area.setAttribute('points', areaPts.join(' '));
    area.setAttribute('fill', '#00a8ff');
    area.setAttribute('opacity', '0.6');
    svg.appendChild(area);

    // optional precip outline for clarity
    const precipLinePts = [];
    for(let i=0;i<takeN;i++){
      const x = 10 + i*xStep;
      const p = (typeof pops[i] === 'number') ? pops[i] : 0;
      const bh = Math.max(0, Math.min(barMaxH, (p/100)*barMaxH));
      const y = barBottom - bh;
      precipLinePts.push(`${x},${y}`);
    }
    const precipLine = document.createElementNS('http://www.w3.org/2000/svg','polyline');
    precipLine.setAttribute('fill','none');
    precipLine.setAttribute('stroke','#008ce0');
    precipLine.setAttribute('stroke-width','2');
    precipLine.setAttribute('points', precipLinePts.join(' '));
    svg.appendChild(precipLine);

    // temp line
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline');
    poly.setAttribute('fill','none');
    poly.setAttribute('stroke','#ffd27d');
    poly.setAttribute('stroke-width','2');
    poly.setAttribute('points', pts.join(' '));
    svg.appendChild(poly);

    // min/max labels
    const lblMin = document.createElementNS('http://www.w3.org/2000/svg','text');
    lblMin.setAttribute('x','8'); lblMin.setAttribute('y',tempBottom+12);
    lblMin.setAttribute('fill','#9fb3d1'); lblMin.setAttribute('font-size','12');
    lblMin.textContent = `${Math.round(tmin)}°F`;
    svg.appendChild(lblMin);

    const lblMax = document.createElementNS('http://www.w3.org/2000/svg','text');
    lblMax.setAttribute('x','8'); lblMax.setAttribute('y',tempTop+12);
    lblMax.setAttribute('fill','#9fb3d1'); lblMax.setAttribute('font-size','12');
    lblMax.textContent = `${Math.round(tmax)}°F`;
    svg.appendChild(lblMax);

  }catch(err){
    console.error(err);
    const nowEl = document.getElementById('now-temp');
    if(nowEl) nowEl.textContent = 'N/A';
    const upd = document.getElementById('now-updated');
    if(upd) upd.textContent = 'Unable to load weather.';
  }
})();
</script>
