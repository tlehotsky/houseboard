<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DayBuddy ‚Äì NFL Schedule Editor</title>
    <style>
      body { background:#050711; color:#f5f7ff; font-family:system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:24px; }
      .card { max-width:1100px; margin:0 auto; background:#111522; border-radius:12px; padding:16px 18px 20px; border:1px solid #262d45; box-shadow:0 18px 40px rgba(0,0,0,0.45); }
      h1 { margin:0 0 4px; font-size:22px; }
      .row { margin-bottom:6px; font-size:13px; opacity:.8; }
      .badges { display:flex; gap:8px; margin:8px 0 10px; flex-wrap:wrap; }
      .badge { font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.02); opacity:0.9; }
      .error { color:#ff9c9c; margin-bottom:8px; font-size:14px; }
      .message { color:#9ff7c2; margin-bottom:8px; font-size:14px; }

      .table-wrapper { margin-top:8px; max-height:70vh; overflow:auto; border-radius:10px; border:1px solid #262d45; background:#050814; }
      table { border-collapse:collapse; width:100%; font-size:12px; min-width:720px; }
      thead { position:sticky; top:0; z-index:5; }
      thead th { background:#181c33; position:sticky; top:0; padding:6px 8px; text-align:left; font-weight:600; border-bottom:1px solid #30385a; white-space:nowrap; }
      tbody tr:nth-child(even) { background:#090d1a; }
      tbody tr:nth-child(odd) { background:#050814; }
      td { padding:3px 6px; border-bottom:1px solid #14182b; }
      /* Hide Match Number column (col 1) */
      th:nth-child(1), td:nth-child(1) { display:none; }
      /* Column width tuning: 1=Match # (hidden), 2=Week #, 3=Date, 4=Time */
      th:nth-child(2), td:nth-child(2) { width: 90px; min-width: 90px; max-width: 90px; }
      th:nth-child(3), td:nth-child(3) { width: 140px; min-width: 140px; max-width: 160px; }
      th:nth-child(4), td:nth-child(4) { width: 110px; min-width: 110px; max-width: 130px; }

      /* Keep these compact and avoid wrapping */
      td:nth-child(2), td:nth-child(3), td:nth-child(4) { white-space: nowrap; }
      td:nth-child(2), th:nth-child(2) { position:sticky; left:0; background:#151a30; box-shadow:2px 0 0 #14182b; }

      /* Center Week Number / Date / Time headings and values */
      th:nth-child(2), td:nth-child(2),
      th:nth-child(3), td:nth-child(3),
      th:nth-child(4), td:nth-child(4) {
        text-align: center;
      }
      td:nth-child(2) .cell-input,
      td:nth-child(3) .cell-input,
      td:nth-child(4) .cell-input {
        text-align: center;
      }
      tbody tr:hover { background:#1a2236; }
      tbody tr:hover td:nth-child(2) { background:#202944; }

      input.cell-input, select.cell-input { width:100%; box-sizing:border-box; border-radius:4px; border:1px solid rgba(255,255,255,0.08); padding:3px 5px; background:rgba(0,0,0,0.25); color:#f5f7ff; font-size:12px; font-family:inherit; }
      input.cell-input:focus, select.cell-input:focus { outline:none; border-color:#5b8dff; box-shadow:0 0 0 1px rgba(91,141,255,0.7); }

      .actions { margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:13px; }
      button { background:#1a2333; color:#f5f7ff; border:1px solid #2a3750; border-radius:999px; padding:7px 16px; font-weight:600; cursor:pointer; }
      button:hover { background:#222d42; }
      a { color:#8fb5ff; text-decoration:none; }
      a:hover { text-decoration:underline; }
      .hint { opacity:0.72; font-size:12px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>NFL Schedule CSV Editor</h1>
      <div style="margin:12px 0; padding:12px; background:#0d1222; border:1px solid #2a314a; border-radius:10px;">
        <div style="font-size:14px; font-weight:600; margin-bottom:6px;">Local TV Schedule Links</div>
        <div style="display:flex; flex-direction:row; flex-wrap:wrap; gap:16px; font-size:13px; align-items:center;">
          <a href="https://www.cbsnews.com/newyork/program-guide/" target="_blank" style="color:#8fb5ff;">üì∫ CBS New York</a>
          <a href="https://www.nbcnewyork.com/tv-schedule/" target="_blank" style="color:#8fb5ff;">üì∫ NBC New York</a>
          <a href="https://www.fox5ny.com/whats-on-fox-5" target="_blank" style="color:#8fb5ff;">üì∫ FOX New York</a>
          <a href="https://abc7ny.com/tvlistings/" target="_blank" style="color:#8fb5ff;">üì∫ ABC New York</a>
        </div>
      </div>
      <div class="row">File: {{ csv_path }}</div>
      <div class="badges">
        <div class="badge">Match Number</div>
        <div class="badge">Round Number</div>
        <div class="badge">Date</div>
        <div class="badge">Time (ET)</div>
        <div class="badge">Location</div>
        <div class="badge">Home / Away Teams</div>
        <div class="badge">Result</div>
        <div class="badge">Broadcast</div>
      </div>

      {% if error %}
        <div class="error">{{ error }}</div>
      {% endif %}
      {% if message %}
        <div class="message">{{ message }}</div>
      {% endif %}

      <form method="post" onsubmit="return syncCsvBeforeSubmit()">
        {% csrf_token %}

        <!-- Hidden raw CSV field that the view reads/writes -->
        <textarea id="csv_raw" name="csv_text" style="display:none;">{{ csv_text|escape }}</textarea>

        <div class="row" style="margin-top:8px; display:flex; gap:8px; align-items:center; font-size:13px;">
          <label for="weekFilter">Filter by Week:</label>
          <select id="weekFilter" style="padding:4px 8px; border-radius:6px; border:1px solid #2a3750; background:#050814; color:#f5f7ff; font-size:13px;">
            <option value="">All weeks</option>
          </select>
        </div>

        <div class="table-wrapper">
          <table id="csvTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="actions">
          <button type="submit">Save CSV</button>
          <a href="/houseboard/daybuddy/week/">‚Üê Back to Week View</a>
          <span class="hint">Times in this file are Eastern Time (ET). Edits are saved exactly as shown.</span>
        </div>
      </form>
    </div>

    <script>
      function parseCsv(text) {
        if (!text) {
          return { headers: [], rows: [] };
        }
        const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter(line => line.trim().length > 0);
        if (lines.length === 0) {
          return { headers: [], rows: [] };
        }
        const headers = lines[0].split(",");
        const rows = lines.slice(1).map(line => line.split(","));
        return { headers, rows };
      }

      function buildTableFromCsv() {
        const rawEl = document.getElementById("csv_raw");
        const table = document.getElementById("csvTable");
        if (!rawEl || !table) return;

        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";

        const data = parseCsv(rawEl.value);
        const headers = data.headers;
        const rows = data.rows;

        if (headers.length === 0) {
          return;
        }

        const headRow = document.createElement("tr");
        headers.forEach(h => {
          const th = document.createElement("th");
          const name = h.trim();
          th.setAttribute("data-original-header", name);
          th.textContent = (name.toLowerCase() === "round number") ? "Week Number" : name;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);

        const weekFilter = document.getElementById("weekFilter");
        const weekSet = new Set();
        const roundIdx = headers.findIndex(h => h.trim().toLowerCase() === "round number");


        const dateIdx = headers.findIndex(h => h.trim().toLowerCase() === "date");
        const timeIdx = headers.findIndex(h => h.trim().toLowerCase() === "time");

        // Determine "current week" as the week number of the next upcoming game
        let currentWeek = "";
        let nextKickoff = null;
        const now = new Date();

        if (roundIdx >= 0 && dateIdx >= 0) {
          rows.forEach(r => {
            const w = (r[roundIdx] || "").trim();
            const ds = (r[dateIdx] || "").trim();
            const ts = timeIdx >= 0 ? (r[timeIdx] || "").trim() : "";
            if (!w || !ds) return;

            const dt = parseLocalDateTime(ds, ts);
            if (!dt || isNaN(dt.getTime())) return;

            if (dt >= now && (nextKickoff === null || dt < nextKickoff)) {
              nextKickoff = dt;
              currentWeek = w;
            }
          });
        }


        rows.forEach((row, rowIdx) => {
          const tr = document.createElement("tr");

          let weekVal = "";
          if (roundIdx >= 0) {
            weekVal = (row[roundIdx] || "").trim();
            if (weekVal) {
              weekSet.add(weekVal);
              tr.setAttribute("data-week", weekVal);
            }
          }


          headers.forEach((_, colIdx) => {
            const td = document.createElement("td");
            if (headers[colIdx].trim().toLowerCase() === "broadcast") {
              const select = document.createElement("select");
              select.className = "cell-input";
              select.setAttribute("data-row", rowIdx);
              select.setAttribute("data-col", colIdx);

              const options = ["CBS", "NBC", "FOX", "ABC", "ESPN", "YouTube", "Prime", "Other", ""];
              options.forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt === "" ? "(blank)" : opt;
                if ((row[colIdx] || "").trim().toLowerCase() === opt.toLowerCase()) {
                  o.selected = true;
                }
                select.appendChild(o);
              });

              td.appendChild(select);
            } else {
              const input = document.createElement("input");
              input.type = "text";
              input.className = "cell-input";
              input.setAttribute("data-row", rowIdx);
              input.setAttribute("data-col", colIdx);

              const headerName = headers[colIdx] ? headers[colIdx].trim() : "";
              const originalValue = (row[colIdx] || "").trim();

              if (isTimeHeader(headerName)) {
                input.value = normalizeTimeTo12h(originalValue);
                attachTimeNormalization(input);
              } else {
                input.value = originalValue;
}







              td.appendChild(input);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        // Populate the week filter dropdown
        if (weekFilter) {
          const currentValue = weekFilter.value;
          weekFilter.innerHTML = "";

          // const optAll = document.createElement("option");
          // optAll.value = "";
          // optAll.textContent = "All weeks";
          // weekFilter.appendChild(optAll);

          const optAll = document.createElement("option");
          optAll.value = "";
          optAll.textContent = "All weeks";
          weekFilter.appendChild(optAll);

          const optCurrent = document.createElement("option");
          optCurrent.value = "__CURRENT__";
          optCurrent.textContent = "Current week";
          if (currentWeek) {
            weekFilter.dataset.currentWeek = currentWeek;
            optCurrent.disabled = false;
          } else {
            delete weekFilter.dataset.currentWeek;
            optCurrent.disabled = true; // no upcoming games found
          }
          weekFilter.appendChild(optCurrent);






          // const optAll = document.createElement("option");
          // optAll.value = "";
          // optAll.textContent = "All weeks";
          // weekFilter.appendChild(optAll);

          Array.from(weekSet)
            .sort((a, b) => {
              const na = parseInt(a, 10);
              const nb = parseInt(b, 10);
              if (!isNaN(na) && !isNaN(nb)) return na - nb;
              return String(a).localeCompare(String(b));
            })
            .forEach(week => {
              const o = document.createElement("option");
              o.value = week;
              o.textContent = "Week " + week;
              weekFilter.appendChild(o);
            });

          if (currentValue && Array.from(weekFilter.options).some(o => o.value === currentValue)) {
            weekFilter.value = currentValue;
          } else {
            weekFilter.value = "";
          }
        }

        // Apply current filter (if any)
        filterRowsByWeek();
      }

      function filterRowsByWeek() {
        const table = document.getElementById("csvTable");
        const weekFilter = document.getElementById("weekFilter");
        if (!table || !weekFilter) return;

        // const value = weekFilter.value.trim();

        let value = weekFilter.value.trim();
        if (value === "__CURRENT__") {
          // for now, treat as "All weeks" until we wire up logic
          value = (weekFilter.dataset.currentWeek || "").trim();
        }

        const rows = Array.from(table.querySelectorAll("tbody tr"));

        rows.forEach(tr => {
          const weekVal = (tr.getAttribute("data-week") || "").trim();
          if (!value || !weekVal) {
            tr.style.display = "";
          } else {
            tr.style.display = (weekVal === value) ? "" : "none";
          }
        });
      }

      function pad2(n) {
        return String(n).padStart(2, "0");
      }

      function normalizeTimeTo12h(raw) {
        if (!raw) return "";
        let v = String(raw).trim();
        if (!v) return "";

        // Already 12h? (e.g., "1:05 PM", "01:05pm")
        const m12 = v.match(/^\s*(\d{1,2})\s*:\s*(\d{2})(?:\s*:\s*(\d{2}))?\s*(AM|PM)\s*$/i);
        if (m12) {
          let h = parseInt(m12[1], 10);
          const min = parseInt(m12[2], 10);
          if (isNaN(h) || isNaN(min) || min < 0 || min > 59) return raw;
          h = ((h - 1 + 12) % 12) + 1; // force 1-12
          const ampm = String(m12[4]).toUpperCase();
          return `${h}:${pad2(min)} ${ampm}`;
        }

        // 24h / ISO-ish? (e.g., "17:00", "01:20:00")
        const m24 = v.match(/^\s*(\d{1,2})\s*:\s*(\d{2})(?:\s*:\s*(\d{2}))?\s*$/);
        if (!m24) return raw;

        let hh = parseInt(m24[1], 10);
        const mm = parseInt(m24[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59) return raw;

        const ampm = hh >= 12 ? "PM" : "AM";
        let h12 = hh % 12;
        if (h12 === 0) h12 = 12;
        return `${h12}:${pad2(mm)} ${ampm}`;
      }

      function isTimeHeader(h) {
        return (h || "").trim().toLowerCase() === "time";
      }

      function attachTimeNormalization(inputEl) {
        if (!inputEl) return;
        // Normalize on blur so user can paste either 24h or 12h and we standardize.
        inputEl.addEventListener("blur", function () {
          inputEl.value = normalizeTimeTo12h(inputEl.value);
        });
      }


      function parseDmyDate(dateStr) {
        // Expected: DD/MM/YYYY
        const s = String(dateStr || "").trim();
        const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (!m) return null;
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        const yyyy = parseInt(m[3], 10);
        if ([dd, mm, yyyy].some(n => isNaN(n))) return null;
        if (mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;
        return { dd, mm, yyyy };
      }

      function parseTimeTo24h(timeStr) {
        const raw = String(timeStr || "").trim();
        if (!raw) return { hh: 0, mi: 0 };

        // 12h (e.g., "1:05 PM", "01:05pm")
        const m12 = raw.match(/^\s*(\d{1,2})\s*:\s*(\d{2})(?:\s*:\s*(\d{2}))?\s*(AM|PM)\s*$/i);
        if (m12) {
          let h = parseInt(m12[1], 10);
          const mi = parseInt(m12[2], 10);
          if (isNaN(h) || isNaN(mi) || mi < 0 || mi > 59) return null;
          const ampm = String(m12[4]).toUpperCase();
          h = h % 12;
          if (ampm === "PM") h += 12;
          return { hh: h, mi };
        }

        // 24h / ISO-ish (e.g., "17:00", "01:20:00")
        const m24 = raw.match(/^\s*(\d{1,2})\s*:\s*(\d{2})(?:\s*:\s*(\d{2}))?\s*$/);
        if (m24) {
          const hh = parseInt(m24[1], 10);
          const mi = parseInt(m24[2], 10);
          if (isNaN(hh) || isNaN(mi) || hh < 0 || hh > 23 || mi < 0 || mi > 59) return null;
          return { hh, mi };
        }

        // Try normalizing and retry
        const norm = normalizeTimeTo12h(raw);
        if (norm && norm !== raw) return parseTimeTo24h(norm);
        return null;
      }

      function parseLocalDateTime(dateStr, timeStr) {
        const d = parseDmyDate(dateStr);
        if (!d) return null;
        const t = parseTimeTo24h(timeStr);
        if (!t) return null;

        // Browser-local Date. Since you view this in ET and the CSV is ET, it behaves as intended.
        return new Date(d.yyyy, d.mm - 1, d.dd, t.hh, t.mi, 0, 0);
      }





      function csvEscape(value) {
        if (value === null || value === undefined) return "";
        const needsQuotes = /[",\n]/.test(value);
        let v = String(value).replace(/"/g, '""');
        return needsQuotes ? '"' + v + '"' : v;
      }

      function syncCsvBeforeSubmit() {
        const table = document.getElementById("csvTable");
        const rawEl = document.getElementById("csv_raw");
        if (!table || !rawEl) return true; // let submit continue

        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.getAttribute("data-original-header") || th.textContent.trim());
        const rows = [];
        const trList = Array.from(table.querySelectorAll("tbody tr"));

        trList.forEach(tr => {
          const cells = [];
          const cellsElems = Array.from(tr.querySelectorAll(".cell-input"));
          cellsElems.forEach(elem => {
            const v = (elem.dataset && typeof elem.dataset.csvValue !== "undefined") ? elem.dataset.csvValue : (elem.value || "");
            cells.push(csvEscape(v));
          });
          rows.push(cells.join(","));
        });

        const headerLine = headers.join(",");
        rawEl.value = [headerLine].concat(rows).join("\n");
        try {
          const wrapper = document.querySelector(".table-wrapper");
          if (wrapper && window.sessionStorage) {
            // Save scroll position
            sessionStorage.setItem("nfl_edit_scroll", String(wrapper.scrollTop));

            // Save the row index the user was working on (if any)
            const active = document.activeElement;
            let rowIndexToSave = null;
            if (active && active.classList && active.classList.contains("cell-input")) {
              rowIndexToSave = active.getAttribute("data-row");
            } else {
              // Fallback: first visible row in the viewport
              const rows = Array.from(wrapper.querySelectorAll("tbody tr"));
              for (const r of rows) {
                const rect = r.getBoundingClientRect();
                const wrapperRect = wrapper.getBoundingClientRect();
                if (rect.bottom > wrapperRect.top) {
                  const firstCellInput = r.querySelector(".cell-input");
                  if (firstCellInput) {
                    rowIndexToSave = firstCellInput.getAttribute("data-row");
                  }
                  break;
                }
              }
            }
            if (rowIndexToSave !== null) {
              sessionStorage.setItem("nfl_edit_row_index", String(rowIndexToSave));
            }
          }
        } catch (e) {
          // ignore scroll persistence errors
        }
        return true; // allow the form submit
      }

      document.addEventListener("DOMContentLoaded", function () {
        buildTableFromCsv();
        const weekFilter = document.getElementById("weekFilter");
        if (weekFilter) {
          weekFilter.addEventListener("change", filterRowsByWeek);
        }
        try {
          const wrapper = document.querySelector(".table-wrapper");
          if (wrapper && window.sessionStorage) {
            const savedRow = sessionStorage.getItem("nfl_edit_row_index");
            if (savedRow !== null) {
              const targetInput = wrapper.querySelector('.cell-input[data-row="' + savedRow + '"]');
              if (targetInput && targetInput.scrollIntoView) {
                targetInput.scrollIntoView({ block: "center" });
                targetInput.focus();
                return; // we've restored position based on row
              }
            }

            const savedScroll = sessionStorage.getItem("nfl_edit_scroll");
            if (savedScroll !== null) {
              const offset = parseInt(savedScroll, 10);
              if (!isNaN(offset)) {
                wrapper.scrollTop = offset;
              }
            }
          }
        } catch (e) {
          // ignore scroll persistence errors
        }
      });
    </script>
  </body>
</html>
